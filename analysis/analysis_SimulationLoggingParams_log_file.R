# analysis/analysis_SimulationLoggingParams_log_file.R
library(ggplot2)
library(dplyr)
library(hadron) # Assuming hadron package is installed and available
source("data_io.R") # Assuming data_io.R is in the working directory

# Function to calculate exp(-delta_H) and perform bootstrapping
analyze_delta_H <- function(data, out_pdf_prefix, skip_steps = 0) {
  data <- data %>% mutate(exp_neg_delta_H = exp(-delta_H))

  # Save the plot generated by bootstrap.analysis to a PDF
  out_pdf <- paste0(out_pdf_prefix, "_bootstrap_exp_neg_delta_H.pdf")
  pdf(out_pdf)
  hadron::bootstrap.analysis(data$exp_neg_delta_H, skip = skip_steps, pl = TRUE)
  dev.off()
}

analyze_acceptance <- function(data, out_pdf_prefix, skip_steps = 0) {
  out_pdf <- paste0(out_pdf_prefix, "_bootstrap_acceptance.pdf")
  pdf(out_pdf)
  hadron::bootstrap.analysis(data$acceptance, skip = skip_steps, pl = TRUE)
  dev.off()
}

analyze_simulation_log <- function(directory, skip_steps = 0) {
  # Read YAML to get configured filename (base pattern)
  config <- read_yaml_config(directory)
  filename <- config$SimulationLoggingParams$log_filename
  if (is.null(filename) || filename == "") {
    stop("SimulationLoggingParams$log_filename not found in YAML")
  }

  # Build pattern to match numbered variants, e.g. simulation_log.txt -> ^simulation_log.*\.txt$
  base_prefix <- sub("\\.txt$", "", filename)
  pattern <- paste0('^', base_prefix, '.*\\.txt$')

  files <- list.files(directory, pattern = pattern, full.names = TRUE)
  if (length(files) == 0) {
    stop(paste0("No simulation log files found matching pattern '", pattern, "' in directory: ", directory))
  }

  for (f in files) {
    message(paste0("Processing simulation log file: ", f))
    base <- basename(f)
    base_noext <- sub("\\.txt$", "", base)
    out_prefix <- file.path(directory, base_noext)

    # Read the log data and run analyses
    log_data <- read_data_file(f)

    # Call the analyze functions which will create PDFs named using out_prefix
    analyze_delta_H(log_data, out_prefix, skip_steps = skip_steps)
    analyze_acceptance(log_data, out_prefix, skip_steps = skip_steps)
  }
}

# Main execution
args <- commandArgs(trailingOnly = TRUE)
if (length(args) != 2) {
  stop("Usage: Rscript analysis_SimulationLoggingParams_log_file.R <directory> <skip_steps>")
}
directory <- args[1]
skip_steps <- args[2]
analyze_simulation_log(directory, skip_steps = as.integer(skip_steps))

