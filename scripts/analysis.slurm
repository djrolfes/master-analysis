#!/bin/bash
#
# SLURM Job Script for Analysis
#
#SBATCH --job-name=wf_analysis
#SBATCH --output=output/slurm-analysis-%j.out
#SBATCH --error=output/slurm-analysis-%j.err
#SBATCH --time=02:00:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32G

set -euo pipefail
module purge
module load GCC/11.2.0
module load R
module load Python

# --- Expect one or more output directories ---
if [ "$#" -lt 1 ]; then
    echo "Error: Missing argument. Usage: sbatch analysis.slurm <output_dir1> [<output_dir2> ...]"
    exit 1
fi

OUTPUT_DIRS=("$@")

# --- Check and Install Hadron once ---
echo "Running check_and_install_hadron.sh..."
if [ -n "${SLURM_JOB_ID:-}" ]; then
    echo "Running with srun..."
    srun ./scripts/check_and_install_hadron.sh
else
    echo "Running without srun..."
    ./scripts/check_and_install_hadron.sh
fi

# --- Python Environment Setup (run once) ---
if [ ! -d ".venv" ]; then
    python3 -m venv .venv
fi

source .venv/bin/activate
pip install --upgrade pip
pip install pandas PyYAML
pip install matplotlib seaborn

# --- Run Analysis for each provided directory sequentially ---

for OUTPUT_DIR in "${OUTPUT_DIRS[@]}"; do
    ABS_OUTPUT_DIR=$(realpath "$OUTPUT_DIR")

    if [ ! -d "$ABS_OUTPUT_DIR" ]; then
        echo "Warning: Output directory does not exist: $ABS_OUTPUT_DIR. Skipping."
        continue
    fi

    echo "Starting analysis job for directory: $ABS_OUTPUT_DIR"
    if [ -n "${SLURM_JOB_ID:-}" ]; then
        echo "Running with srun..."
        srun python3 analysis/analysis.py "$ABS_OUTPUT_DIR"
    else
        echo "Running without srun..."
        python3 analysis/analysis.py "$ABS_OUTPUT_DIR"
    fi
    echo "Analysis job for $ABS_OUTPUT_DIR finished."

    # Move PDFs generated by this run into the output directory
    if compgen -G "*.pdf" > /dev/null; then
        mv -- *.pdf "$ABS_OUTPUT_DIR/"
        echo "Moved generated PDFs to $ABS_OUTPUT_DIR"
    else
        echo "No PDFs generated for $ABS_OUTPUT_DIR"
    fi

done

echo "All requested analyses completed."