#!/bin/bash
#
# SLURM Job Script for Analysis (Single Directory)
#
#SBATCH --job-name=wf_analysis
#SBATCH --output=output/slurm-analysis-%j.out
#SBATCH --error=output/slurm-analysis-%j.err
#SBATCH --time=02:00:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=4
#SBATCH --mem=32G
#SBATCH --exclude=lnode[10-12],lcpunode[01-02]

set -euo pipefail

if [ -n "${SLURM_JOB_ID:-}" ]; then
    module purge
    module load GCC/11.2.0
    module load R
    module load Python
fi

# --- Parse optional -skip flag ---
SKIP_STEPS=250
if [ "$#" -ge 2 ] && [ "$1" = "-skip" ]; then
    SKIP_STEPS="$2"
    shift 2
fi

# --- Expect exactly one output directory ---
if [ "$#" -ne 1 ]; then
    echo "Error: Expected exactly one output directory. Usage: sbatch analysis_single_output.slurm [-skip <n>] <output_dir>"
    exit 1
fi

OUTPUT_DIR="$1"
ABS_OUTPUT_DIR="$(realpath "$OUTPUT_DIR")"

if [ ! -d "$ABS_OUTPUT_DIR" ]; then
    echo "Error: Output directory does not exist: $ABS_OUTPUT_DIR"
    exit 1
fi

# --- Check and Install Hadron ---
echo "Running check_and_install_hadron.sh..."
if [ -n "${SLURM_JOB_ID:-}" ]; then
    echo "Running with srun..."
    srun ./scripts/check_and_install_hadron.sh
else
    echo "Running without srun..."
    ./scripts/check_and_install_hadron.sh
fi

# --- Python Environment Setup ---
if [ ! -d ".venv" ]; then
    echo "Creating new virtual environment..."
    python3 -m venv .venv
    source .venv/bin/activate
    pip install --upgrade pip
    # Install compatible versions to avoid conflicts
    pip install "numpy>=1.16.5,<1.23.0"
    pip install pandas PyYAML matplotlib seaborn
else
    source .venv/bin/activate
    # Check if packages are installed, if not install them
    python3 -c "import pandas, yaml, matplotlib, seaborn" 2>/dev/null || {
        echo "Installing missing packages..."
        pip install --upgrade pip
        pip install "numpy>=1.16.5,<1.23.0"
        pip install pandas PyYAML matplotlib seaborn
    }
fi

# --- Change into analysis directory ---
cd analysis

# --- Run Analysis for the specified directory ---
echo "Starting analysis job for directory: $ABS_OUTPUT_DIR (skip=$SKIP_STEPS)"
if [ -n "${SLURM_JOB_ID:-}" ]; then
    echo "Running with srun..."
    srun python3 analysis.py "$ABS_OUTPUT_DIR" "$SKIP_STEPS"
else
    echo "Running without srun..."
    python3 analysis.py "$ABS_OUTPUT_DIR" "$SKIP_STEPS"
fi
echo "Analysis job for $ABS_OUTPUT_DIR finished."

# Move PDFs generated by this run into the output directory
if compgen -G "*.pdf" > /dev/null; then
    mv -- *.pdf "$ABS_OUTPUT_DIR/"
    echo "Moved generated PDFs to $ABS_OUTPUT_DIR"
else
    echo "No PDFs generated for $ABS_OUTPUT_DIR"
fi

echo "Analysis completed successfully."
